name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        flutter-version: ['3.16.0']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ matrix.flutter-version }}
        cache: true
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Generate code
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
    
    - name: Analyze code
      run: flutter analyze
    
    - name: Run unit tests
      run: flutter test --coverage
    
    - name: Run integration tests
      run: flutter test integration_test/
      if: matrix.os == 'ubuntu-latest'
    
    - name: Build Rust engine
      working-directory: rust_engine
      run: cargo build --release
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      if: matrix.os == 'ubuntu-latest'
      with:
        file: coverage/lcov.info
    
    - name: Build for platform
      run: |
        if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
          flutter build linux --release
        elif [ "${{ matrix.os }}" == "windows-latest" ]; then
          flutter build windows --release
        elif [ "${{ matrix.os }}" == "macos-latest" ]; then
          flutter build macos --release
        fi
      shell: bash

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Run security scan
      uses: securecodewarrior/github-action-add-sarif@v1
      with:
        sarif-file: security-scan.sarif
    
    - name: Dependency vulnerability scan
      run: |
        flutter pub deps --json > deps.json
        # Add vulnerability scanning logic here

  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Check formatting
      run: dart format --set-exit-if-changed .
    
    - name: Analyze code
      run: flutter analyze --fatal-infos
    
    - name: Check for unused dependencies
      run: flutter pub deps --json | jq '.packages[] | select(.kind == "direct") | .name'

  build:
    name: Build Release
    needs: [test, security, quality]
    runs-on: ${{ matrix.os }}
    if: github.ref == 'refs/heads/main'
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: linux
          - os: windows-latest
            target: windows
          - os: macos-latest
            target: macos
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Build Rust engine
      working-directory: rust_engine
      run: cargo build --release
    
    - name: Build Flutter app
      run: flutter build ${{ matrix.target }} --release
    
    - name: Create release artifact
      run: |
        mkdir -p artifacts
        if [ "${{ matrix.target }}" == "linux" ]; then
          tar -czf artifacts/titan-browser-linux.tar.gz -C build/linux/x64/release/bundle .
        elif [ "${{ matrix.target }}" == "windows" ]; then
          7z a artifacts/titan-browser-windows.zip ./build/windows/runner/Release/*
        elif [ "${{ matrix.target }}" == "macos" ]; then
          tar -czf artifacts/titan-browser-macos.tar.gz -C build/macos/Build/Products/Release .
        fi
      shell: bash
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: titan-browser-${{ matrix.target }}
        path: artifacts/